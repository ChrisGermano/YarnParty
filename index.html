<!doctype html>
<html>
<head>
  <title>YarnParty</title>
  <link rel="stylesheet"
href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
crossorigin="anonymous">

<style>
  .card {
    display: block; margin: 150px auto; text-align: center;
  }
  .card-header {
    min-height: 50px;
  }
  .card-block {
    padding: 30px 50px 50px;
  }

  .scoreboard {
    box-shadow: 5px 5px 10px #DDD;
    background: #FEFEFE;
    height: 300px;
    left: 0;
    position: fixed;
    top: 0;
    width: 150px;
  }

  .username {
    border-bottom: 1px solid #DDD;
    margin-top: 15px;
    padding-bottom: 20px;
    text-align: center;
  }
</style>

</head>
  <body>

    <div class="scoreboard">
      <h4 class="username"></h4>
      <br />
      <ul class="scores">
      </ul>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-md-6 offset-md-3">

          <div class="card">
            <div class="card-header">
              <span class="tweetText"></span>
              <br />
              <span class="tweetLength">0</span>/280
              <br />
              <sup class="lengthWarning"></sup>
            </div>
            <div class="card-block">
              <h4 class="card-title timeLeft"></h4>
              <p class="submissions"></p>
              <sup>If "#end" is chosen, the tweet will complete and be posted</sup>
              <form action="">
                <input id="m" autocomplete="off" />
                <button>Send</button>
              </form>
              <sub class="userCount"></sub>
            </div>
          </div>
        </div>
      </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

    <script>
      $(function() {

        const maxTime = 10;
        var timer = maxTime;
        var blacklist = [];

        function nameGen() {

          if (window.localStorage.getItem('yarnparty_user') === null) {

            var possibleC = "BCDFGHJKLMNPQRSTVWXZ";
            var possibleV = "AEIOUY";

            function randomC() {
              return possibleC[Math.floor(Math.random() * possibleC.length)];
            }

            function randomV() {
              return possibleV[Math.floor(Math.random() * possibleV.length)];
            }

            let username = randomC() + randomV() + randomC() + randomC() + randomV();
            window.localStorage.setItem('yarnparty_user',username);
            return username;
          }

          return window.localStorage.getItem('yarnparty_user');

        }

        function uuid() {
          if (window.localStorage.getItem('yarnparty') === null) {
            var chunk = "";
            function s4() {
              return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
            }

            let tempID = s4() + "_" + s4() + "_" + s4() + "_" + s4();

            window.localStorage.setItem('yarnparty',tempID)
            return tempID;
          }

          return window.localStorage.getItem('yarnparty');
        }

        setInterval(function() {
          var timeText = timer === 0 ? "!!! " + timer + " !!!" : "["+timer+"]";
          $('.timeLeft').text(timeText);
          timer--;
          if (timer < 0) timer = 10;
        }, 1000);

        //=====================================================

        $('.username').text(nameGen());

        var socket = io();

        socket.on('refresh', function(groupText) {
          timer = maxTime;
          blacklist = [];
          $('.tweetText').text(groupText.data);
          $('.submissions').text('');
          $('.tweetLength').text(groupText.data.length);
          $('.lengthWarning').text('');

          $('.scores').empty();

          for (var s in groupText.scores) {
            $('.scores').append('<li></li>').text(groupText.scores[s].name + " " + groupText.scores[s].score);
          }
        });

        socket.on('message', function(msg) {

          var oldText = $('.groupText').text();

          msg = JSON.parse(msg);

          var newBank = "";

          for (var o in msg.bank) {
            newBank += msg.bank[o].value + " ";
          }

          newBank = newBank.slice(0, -1);

          $('.groupText').text(msg.nextTweet);
          $('.submissions').text(newBank);
        });

        socket.on('userCount', function(usercount) {
          let author = usercount.users > 1 ? "Authors" : "Author";
          $('.userCount').text(usercount.users + " " + author + " Connected");
          timer = usercount.servertime;
        })

        $('form').submit(function() {

          let formValue = $('#m').val();

          if (formValue == '') {
            return false;
          }

          let pastSubmits = blacklist;
          let newSubmit = formValue.toLowerCase().trim();

          for (var sub in pastSubmits) {
            if (newSubmit == pastSubmits[sub]) {
              $('#m').val('');
              $('.timeLeft').text('You can only submit the same word once!')
              return false;
            }
          }

          let currLength = parseInt($('#tweetLength').text());
          let newWord = parseInt(formValue.length);

          if (currLength + newWord > 280 && $('#m').val() !== "#end") {
            $('.lengthWarning').text('If \"' + formValue + '\" is chosen, it will exceed maximum length and be truncated');
          }

          socket.emit('message', { value: formValue, user: uuid(), name: nameGen() });

          var userSubs = $('#submissions').text();
          userSubs += ' ' + formValue;
          $('#submissions').text(userSubs);

          blacklist.push(formValue);

          $('#m').val('');
          return false;
        });

      });
    </script>
  </body> </html>
