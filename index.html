<!doctype html> <html>
  <head>
    <title>YarnParty</title>
    <link rel="stylesheet" 
href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" 
crossorigin="anonymous">

  <style>
    .card {
      display: block; margin: 150px auto; text-align: center;
    }
    .card-header {
      min-height: 50px;
    }
    .card-block {
      padding: 30px 50px 50px;
    }
  </style>


  </head>
  <body>

    <div class="container">
      <div class="row">
        <div class="col-md-6 offset-md-3">

          <div class="card">
            <div class="card-header">
              <span id="groupText"></span>
              <br />
              <span id="tweetLength">0</span>/280
              <br />
              <sup id="lengthWarning"></sup>                
            </div>
            <div class="card-block">
              <h4 class="card-title" id="timeleft"></h4>
              <p id="submissions"></p>
              <sup>If "#end" is chosen, the tweet will complete and be posted</sup>
              <form action="">
                <input id="m" autocomplete="off" />
                <button>Send</button>
              </form>
              <sub id="usercount"></sub>
            </div>
          </div>
        </div>
      </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

    <script>
      $(function() {

        const maxTime = 10;
        var timer = maxTime;
        var blacklist = [];

        setInterval(function() {
          var timeText = timer === 0 ? "!!! " + timer + " !!!" : "["+timer+"]";
          $('#timeleft').text(timeText);
          timer--;
          if (timer < 0) timer = 10;
        }, 1000);

        var socket = io();

        socket.on('refresh', function(groupText) {
          timer = maxTime;
          blacklist = []; 
          $('#groupText').text(groupText.data);
          $('#submissions').text('');
          $('#tweetLength').text(groupText.data.length);
          $('#lengthWarning').text('');
        });

        socket.on('message', function(msg) {

          var oldText = $('#groupText').text();

          msg = JSON.parse(msg);

          var newBank = msg.bank.join(' ');

          $('#groupText').text(msg.nextTweet);
          $('#submissions').text(newBank);
        });

        socket.on('usercount', function(usercount) {
          let author = usercount.users > 1 ? "Authors" : "Author";
          $('#usercount').text(usercount.users + " " + author + " Connected");
          timer = usercount.servertime;
        })

        $('form').submit(function() {

          if ($('#m').val() == '') {
            return false;
          }

          let pastSubmits = blacklist;
          let newSubmit = $('#m').val().toLowerCase().trim();

          for (var sub in pastSubmits) {
            if (newSubmit == pastSubmits[sub]) {
              $('#m').val('');
              $('#timeleft').text('You can only submit the same word once!')
              return false;
            }
          }

          let currLength = parseInt($('#tweetLength').text());
          let newWord = parseInt($('#m').val().length);

          if (currLength + newWord > 280 && $('#m').val() !== "#end") {
            $('#lengthWarning').text('If \"' + $('#m').val() + '\" is chosen, it will exceed maximum length and be truncated');
          }

          socket.emit('message', $('#m').val());

          var userSubs = $('#submissions').text();
          userSubs += ' ' + $('#m').val();
          $('#submissions').text(userSubs);

          blacklist.push($('#m').val());

          $('#m').val('');
          return false;
        });

      });
    </script>
  </body> </html>
