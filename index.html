<!doctype html>
<html>
<head>
  <title>YarnParty</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Spin together a Twitter story with friends!">

  <link rel="stylesheet"
href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
crossorigin="anonymous">
  <link href="https://fonts.googleapis.com/css?family=Chelsea+Market" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Life+Savers" rel="stylesheet">
  <link href="/css/styles.css" rel="stylesheet">
</head>

  <body>

    <h1>YarnParty</h1>
    <h2>Spin together a Twitter story with friends!</h2>

    <div class="tweetWrapper">

      <div class="timeLeft"></div>

      <span class="tweetText"></span>
      <br />
      <span class="tweetLength">0</span>/280
      <br />
      <sup class="lengthWarning"></sup>
    </div>

    <div class="formWrapper">
      <form action="">
        <input id="m" autocomplete="off" />
        <button>Send</button>
      </form>
      <span><b>If "#end" is chosen, the tweet will be posted!</b></span>
      <br />
      <span class="submissions"></span>
    </div>

    <div class="scoreboard">
      <h4 class="username"></h4>
      <span class="userCount"></span>
      <br />
      <div class="scores"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>

    <script>
      $(function() {

        const maxTime = 10;
        var timer = maxTime;
        var blacklist = [];

        function nameGen() {

          if (window.localStorage.getItem('yarnparty_user') === null) {

            var possibleC = "BCDFGHJKLMNPQRSTVWXZ";
            var possibleV = "AEIOUY";

            function randomC() {
              return possibleC[Math.floor(Math.random() * possibleC.length)];
            }

            function randomV() {
              return possibleV[Math.floor(Math.random() * possibleV.length)];
            }

            let username = randomC() + randomV() + randomC() + randomC() + randomV();
            window.localStorage.setItem('yarnparty_user',username);
            return username;
          }

          return window.localStorage.getItem('yarnparty_user');

        }

        function uuid() {
          if (window.localStorage.getItem('yarnparty') === null) {
            var chunk = "";
            function s4() {
              return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
            }

            let tempID = s4() + "_" + s4() + "_" + s4() + "_" + s4();

            window.localStorage.setItem('yarnparty',tempID)
            return tempID;
          }

          return window.localStorage.getItem('yarnparty');
        }

        setInterval(function() {
          var timeText = timer === 0 ? " " + timer + " " : " "+timer+" ";
          $('.timeLeft').text(timeText);
          timer--;
          if (timer < 0) timer = 10;
        }, 1000);

        //=====================================================

        $('.username').text("Hi, " + nameGen());

        var socket = io();

        socket.on('refresh', function(groupText) {
          timer = maxTime;
          blacklist = [];
          $('.tweetText').text(groupText.data);
          $('.submissions').text('');
          $('.tweetLength').text(groupText.data.length);
          $('.lengthWarning').text('');

          $('.scores').empty();

          console.log(groupText.scores);

          let scoreData = groupText.scores;

          for (var s in scoreData) {
            $('.scores').append("<div class='trophy"+s+"'><img src='/img/trophy.svg'>" + scoreData[s].name + ": " + scoreData[s].score + "</div>");
          }
        });

        socket.on('message', function(msg) {

          var oldText = $('.groupText').text();

          msg = JSON.parse(msg);

          var newBank = "";

          for (var o in msg.bank) {
            newBank += msg.bank[o].value + " ";
          }

          newBank = newBank.slice(0, -1);

          $('.groupText').text(msg.nextTweet);
          $('.submissions').text(newBank);
        });

        socket.on('userCount', function(usercount) {
          let author = usercount.users > 1 ? "Authors" : "Author";
          $('.userCount').text(usercount.users + " " + author + " Connected");
          timer = usercount.servertime;
        })

        $('form').submit(function() {

          let formValue = $('#m').val();

          if (formValue == '') {
            return false;
          }

          let pastSubmits = blacklist;
          let newSubmit = formValue.toLowerCase().trim();

          for (var sub in pastSubmits) {
            if (newSubmit == pastSubmits[sub]) {
              $('#m').val('');
              $('.timeLeft').text('You can only submit the same word once!')
              return false;
            }
          }

          let currLength = parseInt($('#tweetLength').text());
          let newWord = parseInt(formValue.length);

          if (currLength + newWord > 280 && $('#m').val() !== "#end") {
            $('.lengthWarning').text('If \"' + formValue + '\" is chosen, it will exceed maximum length and be truncated');
          }

          socket.emit('message', { value: formValue, user: uuid(), name: nameGen() });

          var userSubs = $('#submissions').text();
          userSubs += ' ' + formValue;
          $('#submissions').text(userSubs);

          blacklist.push(formValue);

          $('#m').val('');
          return false;
        });

      });
    </script>
  </body> </html>
